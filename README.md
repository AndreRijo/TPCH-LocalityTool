# TPC-H Locality tool

This tool modifies a [TPC-H](https://www.tpc.org/tpch/) dataset generated by the [dbgen tool](https://www.tpc.org/tpc_documents_current_versions/current_specifications5.asp) in order to add locality to the orders, instead of them being fully random.

Note: The rest of this document assumes the reader is familiar with [TPC-H](https://www.tpc.org/tpch/) and has read the documentation for [PotionDB](https://github.com/AndreRijo/potionDB/tree/remoteOp) and [PotionDB's TPC-H Client](https://github.com/AndreRijo/TPCH-Client).

## Motivation

[TPC-H](https://www.tpc.org/tpch/) describes an e-commerce scenario.
In such scenarios, customers usually prefer ordering their products from local (i.e., same city, nation or region) suppliers whenever possible, in order to achieve faster delivery times, save on delivery fees and avoid headaches with import procedures.

For example, a spanish customer that intends to buy on Amazon will first check the spanish Amazon (amazon.es) for the products they intend to buy, before considering international Amazon (amazon.com).

The dataset generated by the *dbgen* tool creates orders whose ordered products are supplied by suppliers of random nations!
This means that an order with 10 products has a good chance of having products that come from all continents in the world!
This is highly unrealistic and does not reflect real world usage at all.

TPC-H Locality tool modifies the generated orders in order to add locality to them - that is, after running the tool, some orders will be fully supplied locally (same region), while the remaining ones will feature non-local products with a more realistic approach.
This tool allows you to configure exactly how the distribution of local/non-local is done, featuring multiple configurable modes for non-local.
This allows for interesting experiments and algorithms which take advantage of data locality to be done.

## Requirements

In order to use this tool, you will need:
- The dataset generated by [*dbgen*](https://www.tpc.org/tpc_documents_current_versions/current_specifications5.asp);
- The set of updates generated by [*dbgen*](https://www.tpc.org/tpc_documents_current_versions/current_specifications5.asp);
- The TPC-H header files, available [here](); 
- Either Docker installed in your system (easiest option) or:
- Go installed in your system and a clone of [PotionDB](https://github.com/AndreRijo/potionDB/tree/remoteOp) and [PotionDB's TPC-H client's](https://github.com/AndreRijo/TPCH-Client) repositories (not recommended unless you want to make changes to the code).

## Setup

First, prepare a folder with the required data:

```
tpch_data\
    tables\
    upds\
    headers\
```

Put the tables and updates generated by *dbgen* in, respectively, *tables* and *upds*.
[This page](https://github.com/AndreRijo/TPCH-Client/#TPC-H-tool-and-dataset-generation) explains how to generate both tables and updates with *dbgen*.

Afterwards, follow one of the upcoming options.

#### Option 1: Using Docker and pre-compiled image (easiest solution)

Start by installing Docker: https://docs.docker.com/engine/install/

To obtain the pre-compiled Docker image of the TPC-H locality tool, do:

```
docker pull andrerj/tpchlocality
```

#### Option 2: Using Docker and compile from source

First, prepare a folder to hold all the required files.
We'll refer to such folder as the *baseFolder*.

Afterwards, go inside the *baseFolder* and clone [PotionDB's](https://github.com/AndreRijo/potionDB/tree/remoteOp),  [PotionDB's TPC-H client's](https://github.com/AndreRijo/TPCH-Client) repositories as well as this tool's repository:

```
git clone https://github.com/AndreRijo/potionDB.git potionDB
git clone https://github.com/AndreRijo/TPCH-Client.git tpch_client
git clone https://github.com/AndreRijo/TPCH-LocalityTool.git locality_tool
```

Make sure to checkout PotionDB into the branch *remoteOp*.
For this, go inside the folder *potionDB* and run:

```
git checkout remoteOp
```

If not already done, install Docker. For reference: https://docs.docker.com/engine/install/

Afterwards, from the *baseFolder*, build the Docker image:

```
docker build -f locality_tool/Dockerfile . -t tpchlocality
```

In the [Execution](#Execution) section, for all commands replace `andrerj/tpchlocality` with `tpchlocality`.


#### Option 3: Using Go and running from source, without Docker

Proceed as in [Option 2](#Option-2:-Using-Docker-and-compile-from-source) up to (exclusive) the instalation of Docker.

Make sure you have Go installed:

```
go version
```

If not, check https://go.dev/doc/install on how to install Go.

Now, inside *baseFolder*/locality_tool, run:

```
go run ./main/main.go --data_loc="$path_to_your_folder:"  --sf=$sf --order_rate=$ol --item_rate=$il --one_rem_rate=$orr --two_rem_rate=$trr --two_diff_rem_rate=$tdr --n_upd_files=$nupd
```

For instructions on how to configure each parameter, check the next section.
Replace the docker run command with the one above.

## Execution

To run the tool, use the following:

```
docker run -v "$path_to_your_folder:/go/data/" -e DATA_LOC=/go/data/ -e SF=$sf -e ORDER_LOCALITY=$ol -e ITEM_LOCALITY=$il -e ONE_REM_RATE=$orr -e TWO_REM_RATE=$trr -e TWO_DIFF_REG_REM_RATE=$tdr -e N_UPD_FILES=$nupd --name localityTool andrerj/priv:dp
```

Where: 

- `path_to_your_folder` is the full path to the folder created at the start of [Setup](#Setup) (the *tpch_data* folder) ;
- `sf` is the scale factor (`-s`) used to generate the dataset with the *dbgen* tool (by default, 1);
- `ol` is the desired probability of orders to be fully local;
- `orr` is the desired probability of orders to have exactly one product of a region different from the customer;
- `trr` is the desired probability of orders to have exactly two products of a region different from the customer, with both products being of the **same** region;
- `tdr` is the desired probability of orders to have exactly two products of a region different from the customer, with both products being of **different** regions;
- for orders which are not fully local and not contemplated by the three options above, `il` defines the probability of each individual product in an order to be local to the customer. The non-local products will be from a random region.
- `nupd`is the number of update sets to modify. If using this tool together with [PotionDB's TPC-H client](https://github.com/AndreRijo/TPCH-Client), set this to 1000.

All probabilities are defined with values between 0 and 1, inclusive.
Note that `orr`, `trr` and `tdr` operate over the non-local orders: for example, if `ORDER_LOCALITY = 0.5` and `ONE_REM_RATE = 0.5`, then out of the non-local orders (half of them), half (one quarter of all orders) will have one product from a different region.
Note that `orr` + `trr` + `tdr` <= 1, with the remaining percentage being for orders for which each products' region will be choosen as local or not randomly, based on `il`.

After the tool finishes executing, a folder named *mod* will be created inside the original *tables* and *upds* folders containing respectively the dataset and updates with the modifications made by this tool.

Note that, depending on your operating system and Docker installation, you may need to set up your Docker to allow sharing of folders.

**Notes for VLDB reviewers**: Use the following parameters to obtain a dataset and updates similar to the one used in the experiments in the paper:

```
docker run -v "$path_to_your_folder/:/go/data/" -e DATA_LOC=/go/data/ -e SF=1 -e ORDER_LOCALITY=0.5 -e ITEM_LOCALITY=0.5 -e ONE_REM_RATE=0.25 -e TWO_REM_RATE=0.25 -e TWO_DIFF_REG_REM_RATE=0.25 -e N_UPD_FILES=1000 --name localityTool andrerj/tpchlocality
```

Replace the `$path_to_your_folder` with the location of the folder *tpch_data* created at the start of the [Setup](#Setup) section.